# B树

## 定义

一颗 **m** 阶的 B 树定义如下：

1. 每个结点最有 **m-1** 个关键字。
2. 根结点最少可以只有 **1** 个关键字。
3. 非根结点至少有 **2m - 1** 个关键字。
4. 每个结点中的关键字都按照从小到大的顺序排列，每个关键字的左子树中的所有关键字都小于它，而右子树中的所有关键字都大于它。
5. 所有叶子结点都位于同一层，或者说根结点到每个叶子结点的长度都相同。


## 特性

工程应用中通常 B 树的阶较大（通常 > 100），意味着相同数量节点的 B 树比二叉树低很多。

磁盘操作特性是：低速（相较内存）和大块数据读写（扇区）。树的高度越低，意味着读取磁盘的次数越少。

由于上述特性，在磁盘操作如文件系统或文件数据库场景下， B 树比二叉树更加高效。


## 操作

### 查找

1. 查找节点，由于B树通常是在磁盘上存储的，所以这步需要进行磁盘I/O操作；
2. 查找关键字，当某个节点读入内存后通过顺序或者折半查找来检索关键字，若关键字匹配，则查找结束；
3. 若没有找到关键字，则需要判断大小来找到合适的分支继续步骤 1 - 2。

时间复杂度：O（log n)，n为元素数量。

### 插入

核心思想：向上分裂。

可能出现如下情况：

1. 插入节点元素数量 < (2m -1)

直接插入仍符合树的定义

2. 插入节点元素数量 = （2m-1） 且 父节点元素 < (2m-1)

插入后超过节点容量上限，对当前节点进行分裂处理；产生3个节点，分别包含：m-1，1，m个元素；

其中1个元素插入到父节点中，m-1个元素的节点作为其左孩子，m个元素节点作为有孩子（反之亦可，树操作保持一致即可）。

3.  插入节点元素数量 = （2m-1） 且 父节点元素 = (2m-1)

分裂方式同case2，但是父节点插入分裂元素后不满足树的定义，需要重复case2中情况进行分裂处理。

最终会收敛于根节点（可能是新根节点）。


### 删除


核心思想：借，借不到则合并。


分如下几种情况：


1. 删除元素所在节点元素数量 > (m-1)

直接删除即可。


2. 删除元素所在节点元素数量 = (m-1) 且存在兄弟节点数量 > (m-1)

右兄弟节点中最小元素（或左兄弟节点中最大元素）移至父节点，再将父节点元素移至删除元素所在节点，然后删除元素

> 删除元素所在节点及父节点的元素个数并没有变，被借一个元素的兄弟节点少了一个元素，但是不破坏树的平衡

3. 删除元素所在节点元素数量 = (m-1) 且兄弟节点数量 = (m-1)

此时不能从兄弟接不到空位，将删除元素所在节点与兄弟节点及父节点进行合并处理。

合并后节点元素个数 = （m-1) + 1 + (m-1) = 2m-1，合并后节点可直接删除元素。

注意合并时父节点空缺一个元素，可能出现元素个数 < (m-1)，递归处理，最终会收敛于根节点。
